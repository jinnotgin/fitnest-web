var fs = require("fs"),
  JSONStream = require("JSONStream"),
  es = require("event-stream");

var getStream = function() {
  var jsonData = "_buildings.json",
    stream = fs.createReadStream(jsonData, { encoding: "utf8" }),
    parser = JSONStream.parse("*");
  return stream.pipe(parser);
};

function writeToFile(data, variableName, path) {
  const json = JSON.stringify(data, null, 2);

  const output = `const ${variableName} = ${json}; export default ${variableName};`;

  fs.writeFile(path, output, err => {
    if (err) {
      console.error(err);
      throw err;
    }

    console.log("Saved data to file.");
  });
}

// store in memory only. if needed, we will stream the write to disk in the future
const output = {};
getStream()
  .pipe(
    es.mapSync(function(data) {
      const { LATITUDE, LONGTITUDE, SEARCHVAL } = data;
      output[SEARCHVAL.toLowerCase()] = [LATITUDE, LONGTITUDE];
    })
  )
  .on("end", () => {
    writeToFile(output, "searchables", "_searchables.js");
  });
